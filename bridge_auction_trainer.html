<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Auction Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(ellipse at center, #0f4c75 0%, #1e3c72 50%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="felt" patternUnits="userSpaceOnUse" width="20" height="20"><rect fill="%23134e4a" width="20" height="20"/><circle fill="%23155e56" cx="10" cy="10" r="1"/></pattern></defs><rect fill="url(%23felt)" width="100" height="100"/></svg>') repeat;
            opacity: 0.1;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4), inset 0 2px 8px rgba(255,255,255,0.5);
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
        }

        .session-manager {
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .session-list {
            display: none;
            margin-top: 20px;
        }

        .session-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .create-session {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .create-session:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .game-area {
            display: none;
            padding: 30px;
        }

        .game-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .info-card h3 {
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .info-card .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #343a40;
        }

        .bridge-table {
            display: grid;
            grid-template-columns: 1fr 250px 1fr;
            grid-template-rows: 120px 250px 120px;
            gap: 15px;
            margin: 30px auto;
            max-width: 700px;
            background: radial-gradient(ellipse at center, #0f5132, #198754);
            padding: 20px;
            border-radius: 20px;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.3), 0 8px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .bridge-table::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            background: #2d5a2d;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .position {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: 3px solid #495057;
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .position.current {
            background: linear-gradient(145deg, #d1ecf1, #b8daff);
            border-color: #007bff;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.4), 0 4px 12px rgba(0,0,0,0.15);
            transform: scale(1.05);
        }

        .position-label {
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1.2em;
            color: #2c5aa0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .position.current .position-label {
            color: #0056b3;
        }

        .cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            max-width: 180px;
        }

        .card {
            width: 20px;
            height: 28px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .card.red { color: #dc3545; }
        .card.black { color: #343a40; }

        .north { grid-column: 2; grid-row: 1; }
        .west { grid-column: 1; grid-row: 2; }
        .east { grid-column: 3; grid-row: 2; }
        .south { grid-column: 2; grid-row: 3; }

        .bidding-area {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .auction-history {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .auction-table {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .auction-header {
            background: #6c757d;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 4px;
        }

        .bid-cell {
            background: white;
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .bid-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .bid-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .bid-button {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 3px solid #2c5aa0;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bid-button:hover {
            background: linear-gradient(145deg, #f0f8ff, #e6f3ff);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .bid-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bid-button:disabled {
            background: linear-gradient(145deg, #f8f8f8, #e8e8e8);
            color: #999;
            cursor: not-allowed;
            opacity: 0.5;
            border-color: #ccc;
        }

        .suit-spades { 
            color: #000; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .suit-hearts { 
            color: #ff0000; 
            text-shadow: 1px 1px 2px rgba(255,0,0,0.3);
        }
        .suit-diamonds { 
            color: #ff6600; 
            text-shadow: 1px 1px 2px rgba(255,102,0,0.3);
        }
        .suit-clubs { 
            color: #000; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .suit-nt { 
            color: #0066cc; 
            text-shadow: 1px 1px 2px rgba(0,102,204,0.3);
        }

        .special-calls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .special-call {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            border: 3px solid #b8860b;
            color: #8b4513;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(139,69,19,0.3);
        }

        .special-call:hover {
            background: linear-gradient(145deg, #ffed4e, #fff176);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .special-call:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .alert-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-top: 5px;
        }

        .tree-view {
            display: none;
            padding: 30px;
            background: #f8f9fa;
            margin-top: 20px;
        }

        .tree-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .game-info {
                grid-template-columns: 1fr;
            }
            
            .bidding-area {
                grid-template-columns: 1fr;
            }
            
            .bridge-table {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                max-width: 100%;
            }
            
            .position {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bridge Auction Trainer</h1>
            <p>Partnership Bidding Practice System</p>
            <!-- Comparison View -->
            <div class="comparison-view" id="comparisonView" style="display: none;">
                <div style="padding: 30px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h2>Auction Comparisons</h2>
                        <button class="create-session" onclick="backToSessions()" style="background: #6c757d;">Back to Sessions</button>
                    </div>
                    <div id="comparisonContent">
                        <!-- Comparison content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Session Management -->
            <div class="session-manager">
                <h2>Bidding Sessions</h2>
                <button class="create-session" onclick="showCreateSession()">Create New Session</button>
                <button class="create-session" onclick="showSessions()" style="background: #007bff;">View Sessions</button>
                
                <div class="session-list" id="sessionList">
                    <!-- Sessions will be populated here -->
                </div>
            </div>

            <!-- Game Area -->
            <div class="game-area" id="gameArea">
                <div class="game-info">
                    <div class="info-card">
                        <h3>Current Deal</h3>
                        <div class="value" id="dealNumber">1</div>
                    </div>
                    <div class="info-card">
                        <h3>Dealer</h3>
                        <div class="value" id="dealer">North</div>
                    </div>
                    <div class="info-card">
                        <h3>Vulnerability</h3>
                        <div class="value" id="vulnerability">None</div>
                    </div>
                </div>

                <div class="bridge-table">
                    <div class="position north" id="north">
                        <div class="position-label">North</div>
                        <div class="cards" id="northCards"></div>
                    </div>
                    <div class="position west" id="west">
                        <div class="position-label">West</div>
                        <div class="cards" id="westCards"></div>
                    </div>
                    <div class="position east" id="east">
                        <div class="position-label">East</div>
                        <div class="cards" id="eastCards"></div>
                    </div>
                    <div class="position south" id="south">
                        <div class="position-label">South (You)</div>
                        <div class="cards" id="southCards"></div>
                    </div>
                </div>

                <div class="bidding-area">
                    <div class="auction-history">
                        <h3>Auction History</h3>
                        <div class="auction-table" id="auctionTable">
                            <div class="auction-header">West</div>
                            <div class="auction-header">North</div>
                            <div class="auction-header">East</div>
                            <div class="auction-header">South</div>
                        </div>
                    </div>

                    <div class="bid-controls">
                        <h3>Make Your Call</h3>
                        <div class="bid-buttons" id="bidButtons">
                            <!-- Bid buttons will be generated here -->
                        </div>
                        <div class="special-calls">
                            <button class="special-call" onclick="makeCall('Pass')">Pass</button>
                            <button class="special-call" onclick="makeCall('X')">Double (X)</button>
                            <button class="special-call" onclick="makeCall('XX')">Redouble (XX)</button>
                        </div>
                        <div class="alert-section">
                            <label for="alertText">Alert (optional):</label>
                            <input type="text" id="alertText" class="alert-input" placeholder="Explain your call...">
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="create-session" onclick="showTreeView()" style="background: #17a2b8;">View Auction Tree</button>
                    <button class="create-session" onclick="pauseGame()" style="background: #ffc107; color: #856404;">Pause Game</button>
                    <button class="create-session" onclick="newDeal()" style="background: #28a745;">Next Deal</button>
                </div>
            </div>

            <!-- Tree View -->
            <div class="tree-view" id="treeView">
                <h2>Auction Tree</h2>
                <div class="tree-container" id="treeContainer">
                    <!-- Tree visualization will go here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="create-session" onclick="hideTreeView()">Back to Bidding</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div id="createSessionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideCreateSession()">&times;</span>
            <h2>Create New Bidding Session</h2>
            <div class="form-group">
                <label for="sessionName">Session Name:</label>
                <input type="text" id="sessionName" placeholder="e.g., John and Jane - ACOL System">
            </div>
            <div class="form-group">
                <label for="partnerName">Partner Name:</label>
                <input type="text" id="partnerName" placeholder="Partner's name">
            </div>
            <button class="create-session" onclick="createSession()">Create Session</button>
        </div>
    </div>

    <script>
        // Game state
        let currentSession = null;
        let currentDeal = 1;
        let currentPosition = 'South';
        let auctionHistory = [];
        let hands = {};
        let dealerSequence = ['North', 'East', 'South', 'West'];
        let vulnerabilitySequence = ['None', 'N-S', 'E-W', 'Both'];
        let sessions = JSON.parse(localStorage.getItem('bridgeSessions') || '[]');
        let auctionTree = {};
        let currentPath = [];

        // Card symbols
        const suits = {
            'S': '♠', 'H': '♥', 'D': '♦', 'C': '♣'
        };

        const suitNames = {
            'S': 'Spades', 'H': 'Hearts', 'D': 'Diamonds', 'C': 'Clubs', 'NT': 'No Trump'
        };

        // Initialize the application
        function init() {
            generateBidButtons();
            showSessions();
        }

        // Session management
        function showCreateSession() {
            document.getElementById('createSessionModal').style.display = 'block';
        }

        function hideCreateSession() {
            document.getElementById('createSessionModal').style.display = 'none';
        }

        function createSession() {
            const name = document.getElementById('sessionName').value;
            const partner = document.getElementById('partnerName').value;
            
            if (name && partner) {
                const session = {
                    id: Date.now(),
                    name: name,
                    partner: partner,
                    created: new Date(),
                    deals: []
                };
                sessions.push(session);
                localStorage.setItem('bridgeSessions', JSON.stringify(sessions));
                hideCreateSession();
                showSessions();
                document.getElementById('sessionName').value = '';
                document.getElementById('partnerName').value = '';
            } else {
                alert('Please fill in all fields');
            }
        }

        function showSessions() {
            const sessionList = document.getElementById('sessionList');
            sessionList.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionList.innerHTML = '<p>No sessions yet. Create your first session!</p>';
            } else {
                sessions.forEach(session => {
                    const div = document.createElement('div');
                    div.className = 'session-item';
                    
                    // Count completed games by both players
                    const completedDeals = session.deals.filter(deal => {
                        const playerKeys = Object.keys(deal.players || {});
                        return playerKeys.length === 2 && playerKeys.every(key => deal.players[key].completed);
                    });
                    
                    // Check for paused games
                    const playerId = localStorage.getItem('playerId');
                    const pausedDeal = session.deals.find(deal => 
                        deal.players[playerId] && deal.players[playerId].paused && !deal.players[playerId].completed
                    );
                    
                    div.innerHTML = `
                        <h3>${session.name} ${pausedDeal ? '<span style="color: #ffc107;">⏸️ (Paused)</span>' : ''}</h3>
                        <p>Partner: ${session.partner}</p>
                        <p>Created: ${new Date(session.created).toLocaleDateString()}</p>
                        <p>Total Deals: ${session.deals.length}</p>
                        <p>Completed by Both: ${completedDeals.length}</p>
                        ${pausedDeal ? `<p style="color: #ffc107;"><strong>Paused at Deal ${pausedDeal.dealNumber}</strong></p>` : ''}
                        <div style="margin-top: 10px;">
                            <button class="create-session" onclick="enterSession(${JSON.stringify(session).replace(/"/g, '&quot;')})" 
                                    style="margin: 5px; padding: 8px 15px; font-size: 14px; ${pausedDeal ? 'background: #ffc107; color: #856404;' : ''}">
                                ${pausedDeal ? 'Resume Session' : 'Enter Session'}
                            </button>
                            ${completedDeals.length > 0 ? `
                            <button class="create-session" onclick="viewCompletedGames(${JSON.stringify(session).replace(/"/g, '&quot;')})" 
                                    style="margin: 5px; padding: 8px 15px; font-size: 14px; background: #17a2b8;">
                                View Comparisons
                            </button>
                            ` : ''}
                        </div>
                    `;
                    sessionList.appendChild(div);
                });
            }
            sessionList.style.display = 'block';
        }

        function backToSessions() {
            document.getElementById('comparisonView').style.display = 'none';
            document.querySelector('.session-manager').style.display = 'block';
            showSessions();
        }

        function enterSession(session) {
            currentSession = session;
            
            // Set or get player ID
            let playerId = localStorage.getItem('playerId');
            if (!playerId) {
                playerId = prompt('Enter your player name:') || 'Player' + Math.floor(Math.random() * 1000);
                localStorage.setItem('playerId', playerId);
            }
            
            document.querySelector('.session-manager').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            // Load existing deal or create new one
            if (session.deals.length === 0) {
                // First player creates the deals
                createInitialDeals();
            } else {
                // Load existing deals
                loadExistingDeals();
            }
        }

        function createInitialDeals() {
            // Create initial deal for the session
            currentDeal = 1;
            dealCards();
            
            // Save the deal structure to session (hands are same for both players)
            const dealData = {
                dealNumber: currentDeal,
                hands: JSON.parse(JSON.stringify(hands)),
                dealer: getDealerForDeal(currentDeal),
                vulnerability: getVulnerabilityForDeal(currentDeal),
                players: {}
            };
            
            currentSession.deals.push(dealData);
            updateCurrentSessionStorage();
            
            updateGameInfo();
            updateCurrentPosition();
            updateAuctionDisplay();
            generateBidButtons();
        }

        function loadExistingDeals() {
            // Load the most recent incomplete deal or create a new one
            const playerId = localStorage.getItem('playerId');
            const incompleteDeal = currentSession.deals.find(deal => 
                !deal.players[playerId] || !deal.players[playerId].completed
            );
            
            if (incompleteDeal) {
                // Load existing incomplete deal
                currentDeal = incompleteDeal.dealNumber;
                hands = JSON.parse(JSON.stringify(incompleteDeal.hands));
                
                const playerData = incompleteDeal.players[playerId];
                if (playerData && playerData.paused) {
                    // Resume from paused state
                    auctionHistory = [...(playerData.auctionHistory || [])];
                    currentPosition = playerData.currentPosition || getDealerForDeal(currentDeal);
                    currentPath = [...auctionHistory];
                    
                    // Show resume message
                    setTimeout(() => {
                        alert(`Welcome back! Resuming Deal ${currentDeal}. Current position: ${currentPosition}`);
                    }, 500);
                } else {
                    // Start fresh
                    auctionHistory = [];
                    currentPath = [];
                    
                    // Start from dealer position
                    const dealIndex = (currentDeal - 1) % 16;
                    const dealerIndex = dealIndex % 4;
                    const positions = ['North', 'East', 'South', 'West'];
                    currentPosition = positions[dealerIndex];
                }
            } else {
                // Create new deal
                currentDeal = currentSession.deals.length + 1;
                dealCards();
                
                const dealData = {
                    dealNumber: currentDeal,
                    hands: JSON.parse(JSON.stringify(hands)),
                    dealer: getDealerForDeal(currentDeal),
                    vulnerability: getVulnerabilityForDeal(currentDeal),
                    players: {}
                };
                
                currentSession.deals.push(dealData);
                updateCurrentSessionStorage();
                
                auctionHistory = [];
                currentPath = [];
                
                const dealIndex = (currentDeal - 1) % 16;
                const dealerIndex = dealIndex % 4;
                const positions = ['North', 'East', 'South', 'West'];
                currentPosition = positions[dealerIndex];
            }
            
            updateGameInfo();
            updateCurrentPosition();
            updateAuctionDisplay();
            generateBidButtons();
        }

        function getDealerForDeal(dealNum) {
            const dealIndex = (dealNum - 1) % 16;
            const dealerIndex = dealIndex % 4;
            return ['North', 'East', 'South', 'West'][dealerIndex];
        }

        function getVulnerabilityForDeal(dealNum) {
            const dealIndex = (dealNum - 1) % 16;
            const vulnIndex = Math.floor(dealIndex / 4);
            return ['None', 'N-S', 'E-W', 'Both'][vulnIndex];
        }

        function updateCurrentSessionStorage() {
            const sessionIndex = sessions.findIndex(s => s.id === currentSession.id);
            if (sessionIndex !== -1) {
                sessions[sessionIndex] = currentSession;
                localStorage.setItem('bridgeSessions', JSON.stringify(sessions));
            }
        }

        // Deal generation using Fisher-Yates shuffle
        function shuffleDeck() {
            const deck = [];
            const suits = ['S', 'H', 'D', 'C'];
            const ranks = ['A', 'K', 'Q', 'J', '10', '9', '8', '7', '6', '5', '4', '3', '2'];
            
            suits.forEach(suit => {
                ranks.forEach(rank => {
                    deck.push({suit, rank});
                });
            });
            
            // Fisher-Yates shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            return deck;
        }

        function dealCards() {
            const deck = shuffleDeck();
            hands = {
                North: deck.slice(0, 13),
                East: deck.slice(13, 26),
                South: deck.slice(26, 39),
                West: deck.slice(39, 52)
            };
            
            // Sort hands by suit and rank
            Object.keys(hands).forEach(position => {
                hands[position].sort((a, b) => {
                    const suitOrder = {'S': 0, 'H': 1, 'D': 2, 'C': 3};
                    const rankOrder = {'A': 14, 'K': 13, 'Q': 12, 'J': 11, '10': 10, '9': 9, '8': 8, '7': 7, '6': 6, '5': 5, '4': 4, '3': 3, '2': 2};
                    
                    if (suitOrder[a.suit] !== suitOrder[b.suit]) {
                        return suitOrder[a.suit] - suitOrder[b.suit];
                    }
                    return rankOrder[b.rank] - rankOrder[a.rank];
                });
            });
        }

        function displayCardsWithRotation() {
            // Rotation mapping based on current position
            const rotationMap = {
                'North': {'North': 'south', 'East': 'west', 'South': 'north', 'West': 'east'},
                'East': {'North': 'west', 'East': 'south', 'South': 'east', 'West': 'north'},
                'South': {'North': 'north', 'East': 'east', 'South': 'south', 'West': 'west'},
                'West': {'North': 'east', 'East': 'north', 'South': 'west', 'West': 'south'}
            };
            
            const displayMapping = rotationMap[currentPosition];
            
            // Clear all position containers
            ['north', 'east', 'south', 'west'].forEach(pos => {
                document.getElementById(pos + 'Cards').innerHTML = '';
            });
            
            // Display cards based on rotation
            Object.keys(hands).forEach(realPosition => {
                const displayPosition = displayMapping[realPosition];
                const container = document.getElementById(displayPosition + 'Cards');
                
                // Show cards only for the position displayed as South (current player)
                if (displayPosition === 'south') {
                    hands[realPosition].forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'card ' + (card.suit === 'H' || card.suit === 'D' ? 'red' : 'black');
                        cardElement.textContent = card.rank + suits[card.suit];
                        container.appendChild(cardElement);
                    });
                } else {
                    // Show card backs for other positions
                    for (let i = 0; i < 13; i++) {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'card';
                        cardElement.textContent = '🂠';
                        cardElement.style.background = '#1e3c72';
                        cardElement.style.color = 'white';
                        container.appendChild(cardElement);
                    }
                }
            });
        }

        function newDeal() {
            // Check if current deal exists in session, if not create it
            if (currentSession && !currentSession.deals.find(d => d.dealNumber === currentDeal + 1)) {
                currentDeal++;
                dealCards();
                
                const dealData = {
                    dealNumber: currentDeal,
                    hands: JSON.parse(JSON.stringify(hands)),
                    dealer: getDealerForDeal(currentDeal),
                    vulnerability: getVulnerabilityForDeal(currentDeal),
                    players: {}
                };
                
                currentSession.deals.push(dealData);
                updateCurrentSessionStorage();
            } else if (currentSession) {
                currentDeal++;
                const existingDeal = currentSession.deals.find(d => d.dealNumber === currentDeal);
                if (existingDeal) {
                    hands = JSON.parse(JSON.stringify(existingDeal.hands));
                }
            } else {
                currentDeal++;
                dealCards();
            }
            
            auctionHistory = [];
            currentPath = [];
            auctionTree = {};
            
            updateGameInfo();
            updateAuctionDisplay();
            
            // Start with dealer position based on deal number
            const dealIndex = (currentDeal - 1) % 16;
            const dealerIndex = dealIndex % 4;
            const positions = ['North', 'East', 'South', 'West'];
            currentPosition = positions[dealerIndex];
            
            updateCurrentPosition();
            generateBidButtons();
        }

        // Initialize the app
        init();

        function loadLastDeal() {
            // Implementation for loading existing deals
            newDeal();
        }

        function updateGameInfo() {
            const dealIndex = (currentDeal - 1) % 16;
            const dealer = dealerSequence[dealIndex % 4];
            const vulnIndex = Math.floor(dealIndex / 4);
            const vulnerability = vulnerabilitySequence[vulnIndex];
            
            document.getElementById('dealNumber').textContent = currentDeal;
            document.getElementById('dealer').textContent = dealer;
            document.getElementById('vulnerability').textContent = vulnerability;
        }

        function updateCurrentPosition() {
            document.querySelectorAll('.position').forEach(pos => {
                pos.classList.remove('current');
            });
            
            // Map actual position to display position (user always sees themselves as South)
            const positionMap = {
                'North': 'north',
                'East': 'east', 
                'South': 'south',
                'West': 'west'
            };
            
            // Rotate the view so current position is always shown as South
            const rotationMap = {
                'North': {'north': 'south', 'east': 'west', 'south': 'north', 'west': 'east'},
                'East': {'north': 'west', 'east': 'south', 'south': 'east', 'west': 'north'},
                'South': {'north': 'north', 'east': 'east', 'south': 'south', 'west': 'west'},
                'West': {'north': 'east', 'east': 'north', 'south': 'west', 'west': 'south'}
            };
            
            // Update position labels based on rotation
            const labelMap = rotationMap[currentPosition];
            const positions = ['north', 'east', 'south', 'west'];
            const realPositions = ['North', 'East', 'South', 'West'];
            
            positions.forEach(displayPos => {
                const realPos = Object.keys(labelMap).find(key => labelMap[key] === displayPos);
                const label = document.querySelector(`#${displayPos} .position-label`);
                const realIndex = realPositions.indexOf(realPos.charAt(0).toUpperCase() + realPos.slice(1));
                label.textContent = realPositions[realIndex] + (displayPos === 'south' ? ' (You)' : '');
            });
            
            // Always highlight South position (where user is displayed)
            document.getElementById('south').classList.add('current');
            
            // Update cards display with rotation
            displayCardsWithRotation();
        }

        function generateBidButtons() {
            const container = document.getElementById('bidButtons');
            container.innerHTML = '';
            
            const levels = ['1', '2', '3', '4', '5', '6', '7'];
            const suits = ['C', 'D', 'H', 'S', 'NT'];
            
            levels.forEach(level => {
                suits.forEach(suit => {
                    const button = document.createElement('button');
                    button.className = 'bid-button suit-' + (suit === 'NT' ? 'nt' : suit.toLowerCase());
                    
                    // Create proper suit symbols
                    let suitSymbol = '';
                    if (suit === 'S') suitSymbol = '♠';
                    else if (suit === 'H') suitSymbol = '♥';
                    else if (suit === 'D') suitSymbol = '♦';
                    else if (suit === 'C') suitSymbol = '♣';
                    else if (suit === 'NT') suitSymbol = 'NT';
                    
                    button.innerHTML = `<div style="font-size: 18px; line-height: 1.2;">${level}<br/>${suitSymbol}</div>`;
                    button.onclick = () => makeCall(level + suit);
                    
                    // Check if bid is legal
                    if (!isLegalBid(level + suit)) {
                        button.disabled = true;
                    }
                    
                    container.appendChild(button);
                });
            });
        }

        function isLegalBid(bid) {
            if (auctionHistory.length === 0) return true;
            
            const lastBid = auctionHistory.filter(call => call.type === 'bid').pop();
            if (!lastBid) return true;
            
            const bidValue = getBidValue(bid);
            const lastBidValue = getBidValue(lastBid.call);
            
            return bidValue > lastBidValue;
        }

        function getBidValue(bid) {
            if (!bid.match(/^[1-7][CDHSNT]+$/)) return -1;
            
            const level = parseInt(bid[0]);
            const suit = bid.substring(1);
            const suitValues = {'C': 0, 'D': 1, 'H': 2, 'S': 3, 'NT': 4};
            
            return level * 5 + suitValues[suit];
        }

        function makeCall(call) {
            const alert = document.getElementById('alertText').value;
            
            const callObj = {
                position: currentPosition,
                call: call,
                alert: alert,
                type: call.match(/^[1-7]/) ? 'bid' : 'action'
            };
            
            auctionHistory.push(callObj);
            currentPath.push(callObj);
            
            // Update auction tree
            updateAuctionTree();
            
            updateAuctionDisplay();
            document.getElementById('alertText').value = '';
            
            // Move to next position
            nextPosition();
            generateBidButtons();
            
            // Check if auction is complete
            checkAuctionComplete();
        }

        function nextPosition() {
            const positions = ['West', 'North', 'East', 'South'];
            const currentIndex = positions.indexOf(currentPosition);
            currentPosition = positions[(currentIndex + 1) % 4];
            updateCurrentPosition();
        }

        function updateAuctionDisplay() {
            const table = document.getElementById('auctionTable');
            const headers = table.children;
            
            // Clear existing content except headers
            while (table.children.length > 4) {
                table.removeChild(table.lastChild);
            }
            
            const positions = ['West', 'North', 'East', 'South'];
            let row = 0;
            
            auctionHistory.forEach((call, index) => {
                const posIndex = positions.indexOf(call.position);
                const rowIndex = Math.floor(index / 4);
                
                // Create new row if needed
                while (table.children.length < (rowIndex + 2) * 4) {
                    positions.forEach(() => {
                        const cell = document.createElement('div');
                        cell.className = 'bid-cell';
                        table.appendChild(cell);
                    });
                }
                
                const cellIndex = 4 + rowIndex * 4 + posIndex;
                const cell = table.children[cellIndex];
                cell.textContent = call.call;
                
                if (call.alert) {
                    cell.title = call.alert;
                    cell.style.background = '#fff3cd';
                }
            });
        }

        function checkAuctionComplete() {
            // Count total number of passes in the auction history
            const totalPasses = auctionHistory.filter(call => call.call === 'Pass').length;
            
            if (totalPasses >= 3) {
                showGameOverModal();
                return true;
            }
            
            return false;
        }

        function showGameOverModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="color: #28a745; text-align: center; margin-bottom: 20px;">🎉 Game Over!</h2>
                    <p style="text-align: center; font-size: 18px; margin-bottom: 30px;">
                        3 passes have been used.<br/>
                        The auction is complete!
                    </p>
                    <div style="text-align: center;">
                        <button class="create-session" onclick="saveGameAndContinue()" style="margin: 0 10px;">
                            Save & Next Deal
                        </button>
                        <button class="create-session" onclick="viewAuctionTree()" style="background: #17a2b8; margin: 0 10px;">
                            View Auction Tree
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Save current game to session
            saveCurrentGame();
        }

        function saveGameAndContinue() {
            document.querySelector('.modal').remove();
            newDeal();
        }

        function viewAuctionTree() {
            document.querySelector('.modal').remove();
            showTreeView();
        }

        function saveCurrentGame() {
            if (!currentSession) return;
            
            const gameData = {
                dealNumber: currentDeal,
                hands: JSON.parse(JSON.stringify(hands)),
                auctionHistory: [...auctionHistory],
                dealer: document.getElementById('dealer').textContent,
                vulnerability: document.getElementById('vulnerability').textContent,
                playerId: localStorage.getItem('playerId') || 'Player1',
                timestamp: new Date().toISOString(),
                completed: true
            };
            
            // Find or create deal in session
            let dealIndex = currentSession.deals.findIndex(d => d.dealNumber === currentDeal);
            if (dealIndex === -1) {
                currentSession.deals.push({
                    dealNumber: currentDeal,
                    hands: gameData.hands,
                    dealer: gameData.dealer,
                    vulnerability: gameData.vulnerability,
                    players: {}
                });
                dealIndex = currentSession.deals.length - 1;
            }
            
            // Save this player's auction
            currentSession.deals[dealIndex].players[gameData.playerId] = {
                auctionHistory: gameData.auctionHistory,
                timestamp: gameData.timestamp,
                completed: true
            };
            
            // Update sessions in localStorage
            const sessionIndex = sessions.findIndex(s => s.id === currentSession.id);
            if (sessionIndex !== -1) {
                sessions[sessionIndex] = currentSession;
                localStorage.setItem('bridgeSessions', JSON.stringify(sessions));
            }
        }

        function updateAuctionTree() {
            // Build tree structure for comparison with partner
            const pathKey = currentPath.map(c => c.call).join('-');
            if (!auctionTree[pathKey]) {
                auctionTree[pathKey] = {
                    path: [...currentPath],
                    complete: false
                };
            }
        }

        function showTreeView() {
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('treeView').style.display = 'block';
            renderAuctionTree();
        }

        function hideTreeView() {
            document.getElementById('treeView').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
        }

        function renderAuctionTree() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '<h3>Auction Paths</h3>';
            
            Object.keys(auctionTree).forEach(path => {
                const div = document.createElement('div');
                div.style.margin = '10px 0';
                div.style.padding = '10px';
                div.style.background = '#f8f9fa';
                div.style.borderRadius = '5px';
                div.innerHTML = `<strong>Path:</strong> ${path.replace(/-/g, ' → ')}`;
                container.appendChild(div);
            });
            
            if (Object.keys(auctionTree).length === 0) {
                container.innerHTML += '<p>No auction paths recorded yet.</p>';
            }
        }

        function viewCompletedGames(session) {
            document.querySelector('.session-manager').style.display = 'none';
            document.getElementById('comparisonView').style.display = 'block';
            
            const content = document.getElementById('comparisonContent');
            content.innerHTML = '<h3>Completed Games for: ' + session.name + '</h3>';
            
            const completedDeals = session.deals.filter(deal => {
                const playerKeys = Object.keys(deal.players || {});
                return playerKeys.length === 2 && playerKeys.every(key => deal.players[key].completed);
            });
            
            if (completedDeals.length === 0) {
                content.innerHTML += '<p>No completed games by both players yet.</p>';
                return;
            }
            
            completedDeals.forEach((deal, index) => {
                const dealDiv = document.createElement('div');
                dealDiv.className = 'session-item';
                dealDiv.style.marginBottom = '20px';
                
                const playerNames = Object.keys(deal.players);
                dealDiv.innerHTML = `
                    <h4>Deal ${deal.dealNumber}</h4>
                    <p>Dealer: ${deal.dealer} | Vulnerability: ${deal.vulnerability}</p>
                    <p>Players: ${playerNames.join(' vs ')}</p>
                    <button class="create-session" onclick="showDetailedComparison(${JSON.stringify(deal).replace(/"/g, '&quot;')}, '${session.name}')" 
                            style="background: #28a745; font-size: 14px; padding: 8px 15px;">
                        Compare Auctions
                    </button>
                `;
                content.appendChild(dealDiv);
            });
        }

        function showDetailedComparison(deal, sessionName) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const playerNames = Object.keys(deal.players);
            let comparisonHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>Deal ${deal.dealNumber} Comparison - ${sessionName}</h2>
                    <div style="margin-bottom: 20px;">
                        <p><strong>Dealer:</strong> ${deal.dealer} | <strong>Vulnerability:</strong> ${deal.vulnerability}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            `;
            
            playerNames.forEach(playerName => {
                const playerData = deal.players[playerName];
                comparisonHTML += `
                    <div>
                        <h3>${playerName}'s Auction</h3>
                        <div class="auction-table" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 15px 0; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div class="auction-header">West</div>
                            <div class="auction-header">North</div>
                            <div class="auction-header">East</div>
                            <div class="auction-header">South</div>
                `;
                
                // Add auction history
                const positions = ['West', 'North', 'East', 'South'];
                playerData.auctionHistory.forEach((call, index) => {
                    const posIndex = positions.indexOf(call.position);
                    const rowIndex = Math.floor(index / 4);
                    
                    // Add empty cells if needed
                    while ((rowIndex + 1) * 4 > playerData.auctionHistory.length + (4 - (index % 4))) {
                        comparisonHTML += '<div class="bid-cell"></div>';
                    }
                    
                    comparisonHTML += `<div class="bid-cell" style="background: white; border: 1px solid #dee2e6; padding: 8px; text-align: center; ${call.alert ? 'background: #fff3cd; title="' + call.alert + '"' : ''}">${call.call}</div>`;
                });
                
                comparisonHTML += `</div></div>`;
            });
            
            comparisonHTML += `
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3>Add Comments</h3>
                        <textarea id="comparisonComments" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" 
                                  placeholder="Add your observations about the differences in bidding..."></textarea>
                        <button class="create-session" onclick="saveComments(${deal.dealNumber}, '${sessionName}')" style="margin-top: 10px;">
                            Save Comments
                        </button>
                    </div>
                    
                    ${deal.comments ? `<div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px;"><h4>Previous Comments:</h4><p>${deal.comments}</p></div>` : ''}
                </div>
            `;
            
            modal.innerHTML = comparisonHTML;
            document.body.appendChild(modal);
        }

        function saveComments(dealNumber, sessionName) {
            const comments = document.getElementById('comparisonComments').value;
            if (!comments.trim()) return;
            
            // Find and update the session
            const session = sessions.find(s => s.name === sessionName);
            if (session) {
                const deal = session.deals.find(d => d.dealNumber === dealNumber);
                if (deal) {
                    deal.comments = (deal.comments || '') + '\n' + new Date().toLocaleString() + ': ' + comments;
                    localStorage.setItem('bridgeSessions', JSON.stringify(sessions));
                    alert('Comments saved successfully!');
                    document.querySelector('.modal').remove();
                }
            }
        }

        function pauseGame() {
            // Save current game state
            saveCurrentGameState();
            
            // Show pause confirmation modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="color: #ffc107; text-align: center; margin-bottom: 20px;">⏸️ Game Paused</h2>
                    <p style="text-align: center; font-size: 16px; margin-bottom: 30px;">
                        Your current game has been saved.<br/>
                        You can resume anytime by entering this session again.
                    </p>
                    <div style="text-align: center;">
                        <button class="create-session" onclick="resumeGame()" style="margin: 0 10px; background: #28a745;">
                            Resume Game
                        </button>
                        <button class="create-session" onclick="exitToSessions()" style="background: #6c757d; margin: 0 10px;">
                            Exit to Sessions
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveCurrentGameState() {
            if (!currentSession) return;
            
            const playerId = localStorage.getItem('playerId');
            
            // Find current deal in session
            let dealIndex = currentSession.deals.findIndex(d => d.dealNumber === currentDeal);
            if (dealIndex === -1) {
                // Create new deal if it doesn't exist
                currentSession.deals.push({
                    dealNumber: currentDeal,
                    hands: JSON.parse(JSON.stringify(hands)),
                    dealer: getDealerForDeal(currentDeal),
                    vulnerability: getVulnerabilityForDeal(currentDeal),
                    players: {}
                });
                dealIndex = currentSession.deals.length - 1;
            }
            
            // Save current state (even if incomplete)
            currentSession.deals[dealIndex].players[playerId] = {
                auctionHistory: [...auctionHistory],
                currentPosition: currentPosition,
                timestamp: new Date().toISOString(),
                completed: false,
                paused: true
            };
            
            // Update sessions in localStorage
            updateCurrentSessionStorage();
        }

        function resumeGame() {
            document.querySelector('.modal').remove();
            // Game continues from current state
        }

        function exitToSessions() {
            document.querySelector('.modal').remove();
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('treeView').style.display = 'none';
            document.getElementById('comparisonView').style.display = 'none';
            document.querySelector('.session-manager').style.display = 'block';
            showSessions();
        }
    </script>
</body>
</html>